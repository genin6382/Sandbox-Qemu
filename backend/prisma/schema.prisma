/*
  This is the Prisma schema file for the application.
  It defines the database models and their relationships.
*/

enum NodeStatus {
  STOPPED
  RUNNING
  ERROR
  IDLE
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Only for admins
model Users {
  id       String   @id @default(cuid())
  password String

  @@map("users")
}

model ISOs {
  isoId        String   @id @default(cuid())
  name      String  
  path      String   @unique
  createdAt DateTime @default(now())
  Images   Images[]

  @@index([name])
  @@map("isos")
}


// Schema for Qemu Images
model Images {
  baseId      String    @id @default(cuid())
  name        String
  path        String    @unique
  size        Int
  isoId       String
  overlayCount Int       @default(0)
  createdAt   DateTime  @default(now())

  iso         ISOs      @relation(fields: [isoId], references: [isoId])
  nodes       Nodes[]

  @@index([isoId,overlayCount])
  @@map("images")
}

// Schema for Qemu Nodes
model Nodes {
  id                String    @id @default(cuid())
  name              String
  overlayPath       String    @unique
  vncPort           Int       @unique
  pid               Int?    
  gucaConnectionId  String?   @unique
  status            NodeStatus @default(IDLE)
  baseId            String
  createdAt         DateTime  @default(now())

  baseImage       Images   @relation(fields: [baseId], references: [baseId])
  logs            Logs[]

  @@map("nodes")
  @@index([baseId, status]) // For faster querying of nodes by image and status
}

// Schema for Logs 
model Logs {
  id       String   @id @default(cuid())
  nodeId   String
  message  String
  createdAt DateTime @default(now())

  node     Nodes    @relation(fields: [nodeId], references: [id])

  @@map("logs")
}

